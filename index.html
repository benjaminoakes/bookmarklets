<!DOCTYPE html>
<html>
  <head>
    <title>Bookmarklets</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#000000">
  </head>
  <body>
    <main>
      <form>
        <select autofocus onchange="handleSelect(event)">
          <option disabled selected>Choose bookmarklet</option>
          <option value="http://www.bugmenot.com/view/{{hostname}}">BugMeNot 🪲</option>
          <option value="https://www.camelcamelcamel.com/search?sq={{url}}">Camel Camel Camel 🐫</option>
          <option value="https://www.web2pdfconvert.com/#{{rawUrl}}">Convert to PDF 📃</option>
          <option value="mailto:?subject={{title}}&body={{url}}">Email 📫</option>
          <option value="mailto:{{selfEmail}}?subject={{title}}&body={{url}}">Email Self 🤳</option>
          <option value="mailto:{{spouseEmail}}?subject={{title}}&body={{url}}">Email Spouse ❤️</option>
          <option value="mailto:{{workEmail}}?subject={{title}}&body={{url}}">Email Self at Work 🏢</option>
          <option value="https://www.instapaper.com/hello2?u={{url}}&t={{title}}">Instapaper 📰</option>
          <option value="https://www.instapaper.com/text?u={{url}}">Instapaper Text 📖</option>
          <option value="https://outline.com/{{rawUrl}}">Outline 📃</option>
          <option value="https://www.reviewmeta.com/search?q={{url}}">ReviewMeta 🇷</option>
          <option value="https://smmry.com/{{rawUrl}}">SMMRY ➡️</option>
          <option value="http://web.archive.org/web/*/{{rawUrl}}">Wayback Machine 🕓</option>
        </select>
      </form>

      <details>
        <summary style="cursor:pointer">Configuration</summary>
        <form onsubmit="saveToLocalStorage(event)">
          <label for="selfEmail">Self Email</label><br>
          <input type="text" name="selfEmail"><br>
          <label for="spouseEmail">Spouse Email</label><br>
          <input type="text" name="spouseEmail"><br>
          <label for="workEmail">Work Email</label><br>
          <input type="text" name="workEmail"><br>
          <input type="submit" value="Save">
        </form>
      </details>
    </main>
  </body>
  <script>
function handleSelect (event) {
  const searchParams = (new URL(document.location)).searchParams

  const url = searchParams.get("url")
  const parsedUrl = new URL(url)
  const title = searchParams.get("title")

  const redirectUrl = event.target.value

  const rewrittenUrl = redirectUrl.
    replace("{{selfEmail}}", encodeURIComponent(localStorage.selfEmail)).
    replace("{{spouseEmail}}", encodeURIComponent(localStorage.spouseEmail)).
    replace("{{workEmail}}", encodeURIComponent(localStorage.workEmail)).
    replace("{{hostname}}", encodeURIComponent(parsedUrl.hostname)).
    replace("{{url}}", encodeURIComponent(url)).
    replace("{{rawUrl}}", url).
    replace("{{title}}", encodeURIComponent(title))

  document.location = rewrittenUrl
}

function saveToLocalStorage(event) {
  event.preventDefault()

  Array.from(event.target).forEach(function (input) {
    localStorage[input.name] = input.value
  })

  alert("Saved!")
}
  </script>
</html>
